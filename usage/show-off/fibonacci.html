<!doctype html>
<html class="fixed sidebar-light">
<head>
    <meta charset="UTF-8">

    <title>Fibonacci Example Â· swave</title>
    <meta name="keywords" content="scala, streams, streaming, reactive, asynchronous, non-blocking" />
    <meta name="description" content='A Reactive Streams infrastructure implementation in Scala'>
    <meta name="author" content="The swave team">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,800|Shadows+Into+Light" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../../assets/css/theme.css" />
    <link rel="stylesheet" href="../../assets/css/skins/default.css" />
    <link rel="stylesheet" href="../../assets/css/theme-custom.css">
    <link rel="stylesheet" href="../../assets/vendor/highlight/github.css">

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="apple-mobile-web-app-title" content="swave.io">
    <meta name="application-name" content="swave.io">
    <meta name="theme-color" content="#ffffff">

    <script src="../../assets/vendor/modernizr/modernizr.js"></script>
</head>
<body >
<section class="body">

    <header class="header">
        <div class="logo-container">
            <a href="../../index.html" class="logo">
                <img src="../../assets/img/swave-logo.svg" height="35" alt="swave" />
            </a>
            <div class="visible-xs toggle-sidebar-left" data-toggle-class="sidebar-left-opened" data-target="html" data-fire-event="sidebar-left-opened">
                <i class="fa fa-bars" aria-label="Toggle sidebar"></i>
            </div>
        </div>

        <div class="header-right hidden-xs">
            <ul class="social-icons">
                <li class="social-icons-github"><a href="https://github.com/sirthias/swave/" target="_blank" title="Github"><i class="fa fa-github"></i></a></li>
                <li class="social-icons-email"><a href="https://groups.google.com/forum/#!forum/swave-user" target="_blank" title="Mailing List"><i class="fa fa-envelope"></i></a></li>
                <li class="social-icons-twitter"><a href="https://twitter.com/swaveio/" target="_blank" title="Twitter"><i class="fa fa-twitter"></i></a></li>
            </ul>
            <div id="talks-link">
                <a href="../../introduction/talks-on-swave.html" title="Watch the latest introductory talks for swave!">
                    <i class="fa fa-chevron-right" aria-hidden="true"></i>&nbsp;
                    <i class="fa fa-video-camera" aria-hidden="true"></i>&nbsp;Watch an intro talk on swave!&nbsp;
                    <i class="fa fa-chevron-left" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </header>

    <div class="inner-wrapper">
        <aside id="sidebar-left" class="sidebar-left">

            <div class="sidebar-header">
                <div class="sidebar-title">
                    Content
                </div>
                <div class="sidebar-toggle hidden-xs" data-toggle-class="sidebar-left-collapsed" data-target="html" data-fire-event="sidebar-left-toggle">
                    <i class="fa fa-bars" aria-label="Toggle sidebar"></i>
                </div>
            </div>

            <div class="nano">
                <div class="nano-content">
                    <nav id="menu" class="nav-main" role="navigation">
                        <ul class="nav nav-main">
                          <li class="nav-parent"><a><i class="fa fa-blind" aria-hidden="true"></i><span>Introduction</span></a>
                          <ul class="nav nav-children">
                            <li><a href="../../introduction/overview.html">Overview</a></li>
                            <li><a href="../../introduction/reactive-streams.html">Reactive Streams</a></li>
                            <li><a href="../../introduction/swave-vs-akka-stream.html"><em>swave</em> vs. Akka-Stream</a></li>
                            <li><a href="../../introduction/talks-on-swave.html">Talks on <em>swave</em></a></li>
                          </ul></li>
                          <li class="nav-parent nav-expanded nav-active"><a><i class="fa fa-book" aria-hidden="true"></i><span>User Documentation</span></a>
                          <ul class="nav nav-children">
                            <li class="nav-parent nav-expanded nav-active"><a>Show-Off</a>
                            <ul class="nav nav-children">
                              <li><a href="../../usage/show-off/overview.html">Show-Off Overview</a></li>
                              <li><a href="../../usage/show-off/md5.html">MD5 Example</a></li>
                              <li class="nav-expanded nav-active"><a href="../../usage/show-off/fibonacci.html">Fibonacci Example</a></li>
                            </ul></li>
                            <li><a href="../../usage/setup.html">Setup</a></li>
                            <li><a href="../../usage/quick-start.html">Quick Start</a></li>
                            <li><a href="../../usage/basics.html">Basics</a></li>
                            <li><a href="../../usage/spouts.html">Spouts</a></li>
                            <li><a href="../../usage/drains.html">Drains</a></li>
                            <li class="nav-parent"><a>Transformations</a>
                            <ul class="nav nav-children">
                              <li><a href="../../usage/transformations/overview.html">Transformations Overview</a></li>
                              <li><a href="../../usage/transformations/simple.html">Simple Transformations</a></li>
                              <li><a href="../../usage/transformations/fan-ins.html">Fan-Ins</a></li>
                              <li><a href="../../usage/transformations/fan-outs.html">Fan-Outs</a></li>
                              <li><a href="../../usage/transformations/streams-of-streams.html">Streams-of-Streams</a></li>
                              <li><a href="../../usage/transformations/couplings.html">Couplings</a></li>
                              <li><a href="../../usage/transformations/reference/index.html">Transformation Reference</a></li>
                            </ul></li>
                            <li class="nav-parent"><a>Further Topics</a>
                            <ul class="nav nav-children">
                              <li><a href="../../usage/further/sync-vs-async.html">Sync vs. Async</a></li>
                              <li><a href="../../usage/further/pipes.html">Pipes</a></li>
                              <li><a href="../../usage/further/modules.html">Modules</a></li>
                              <li><a href="../../usage/further/debugging.html">Debugging</a></li>
                              <li><a href="../../usage/further/rendering.html">Rendering</a></li>
                              <li><a href="../../usage/further/configuration.html">Configuration</a></li>
                              <li><a href="../../usage/further/best-practices.html">Best Practices</a></li>
                            </ul></li>
                            <li class="nav-parent"><a>IO Adapters</a>
                            <ul class="nav nav-children">
                              <li><a href="../../usage/io/file-io.html">File IO</a></li>
                              <li><a href="../../usage/io/tcp.html">Network IO (TCP)</a></li>
                            </ul></li>
                            <li><a href="../../usage/swave-core-api.html">API Docs (ScalaDoc)</a></li>
                            <li><a href="../../usage/swave-akka-compat/index.html">swave-akka-compat</a></li>
                            <li><a href="../../usage/swave-scodec-compat/index.html">swave-scodec-compat</a></li>
                            <li><a href="../../usage/swave-testkit/index.html">swave-testkit</a></li>
                          </ul></li>
                          <li><a href="../../dev/index.html"><i class="fa fa-cogs" aria-hidden="true"></i><span>Developer Documentation</span></a></li>
                          <li class="nav-parent"><a><i class="fa fa-info-circle" aria-hidden="true"></i><span>Project Info</span></a>
                          <ul class="nav nav-children">
                            <li><a href="../../project/license.html">License</a></li>
                            <li><a href="../../project/contributing.html">Contributing</a></li>
                            <li><a href="../../project/changelog.html">Changelog</a></li>
                            <li><a href="../../project/sponsors.html">Sponsors</a></li>
                            <li><a href="../../project/references.html">References</a></li>
                          </ul></li>
                          <li><a href="../../support.html"><i class="fa fa-users" aria-hidden="true"></i><span>Support</span></a></li>
                        </ul>
                    </nav>
                </div>

                <script>
                    // Maintain Scroll Position
                    if (typeof localStorage !== 'undefined') {
                        if (localStorage.getItem('sidebar-left-position') !== null) {
                            var initialPosition = localStorage.getItem('sidebar-left-position'),
                                    sidebarLeft = document.querySelector('#sidebar-left .nano-content');

                            sidebarLeft.scrollTop = initialPosition;
                        }
                    }
                </script>

            </div>

        </aside>

        <section role="main" class="content-body">
            <header class="page-header">
                <ul class="breadcrumbs">
                  <li><a href="../../index.html"><i class="fa fa-home"></i></a></li>
                  <li><a href="../../usage/index.html">User Documentation</a></li>
                  <li><a href="../../usage/show-off/index.html">Show-Off</a></li>
                  <li>Fibonacci Example</li>
                </ul>
            </header>
            <div id="main-content">
                <!-- start: page -->
<h1><a href="#fibonacci-example" name="fibonacci-example" class="anchor"><span class="anchor-link"></span></a>Fibonacci Example</h1>
<p>This example shows how you can use a stream graph to model recursive algorithms like the generation of the stream of all fibonacci numbers.</p>
<p>Here is a very simple way to create an infinite stream of all Fibonacci numbers that relies on an <code>unfold</code> <a href="../spouts.html">Spout</a>:</p>
<pre><code class="scala">import swave.core._
implicit val env = StreamEnv()

// the &quot;infinite&quot; stream of all Fibonacci numbers
def fibonacciNumbers: Spout[Int] =
  Spout.unfold(0 -&gt; 1) { case (a, b) =&gt;
    Spout.Unfolding.Emit(elem = a, next = b -&gt; (a + b))
  }

fibonacciNumbers
  .take(8)
  .drainToList(limit = 100)
  .value.get.get shouldEqual List(0, 1, 1, 2, 3, 5, 8, 13)</code></pre>
<p>While this is a concise and efficient implementation the recursion required for the stream generation is hereby provided by the &ldquo;unfolding&rdquo; feature. As such it is &ldquo;built-in&rdquo; and not that interesting from a &ldquo;show-off&rdquo; perspective.</p>
<p>A maybe more illustrative way to construct the same stream is the following one, which makes the recursion explicit in the stream graph structure:</p>
<pre><code class="scala">import swave.core._
implicit val env = StreamEnv()

def fibonacciNumbers = {
  val c = Coupling[Int]
  Spout(0, 1)
    .concat(c.out)
    .fanOutBroadcast(eagerCancel = true)
      .sub.buffer(2, Buffer.RequestStrategy.Always).sliding(2).map(_.sum).to(c.in)
      .subContinue
}

fibonacciNumbers
  .take(8)
  .drainToList(limit = 100)
  .value.get.get shouldEqual List(0, 1, 1, 2, 3, 5, 8, 13)</code></pre>
<p>The stream graph defined by this code can be visualized like this:</p><p class="centered"><img src="../../assets/img/fibobacci-graph.svg" alt="Fibonacci Example Stream Graph" /></p>
<p>As you can see this graph contains a cycle, which is the source for the infinite nature of the stream.<br/> Let&rsquo;s understand how this setup works by tracing the initial phase of the stream execution step by step:</p>
<ol>
  <li>
  <p>When the stream is started three <a href="../basics.html">stages</a> begin to actively send signals: the main <a href="../drains.html">Drain</a> at the very end,  the <a href="../transformations/reference/buffer.html">buffer</a> stage in the first fan-out sub branch and the <a href="../transformations/reference/take.html">sliding</a> stage right behind it.  All 3 stages signal demand to the upstreams. The main drain signals demand for <code>Int.MaxValue</code> elements and the  <a href="../transformations/reference/buffer.html">buffer</a> and <a href="../transformations/reference/take.html">sliding</a> stages each signal demand for 2 elements.</p></li>
  <li>
  <p>The <a href="../transformations/reference/take.html">take</a> stage receives the demand signal from its downstream and forwards it as <code>Request(8)</code> to its own  upstream, which, via the <code>subContinue</code>, is the <a href="../transformations/reference/fanOutBroadcast.html">fanOutBroadcast</a> stage.</p></li>
  <li>
  <p>The <a href="../transformations/reference/fanOutBroadcast.html">fanOutBroadcast</a> stage receives the demand signal for 2 elements (from the <a href="../transformations/reference/buffer.html">buffer</a> stage) on its first  sub stream and a demand of 8 on its second sub stream. It therefore signals a demand of 2 to its own upstream,  the <a href="../transformations/reference/concat.html">concat</a>.</p></li>
  <li>
  <p>The <a href="../transformations/reference/concat.html">concat</a> stage forwards this demand to its first upstream, the <code>Spout(0, 1)</code>, which immediately delivers  two elements and signals completion.</p></li>
  <li>
  <p>The <a href="../transformations/reference/concat.html">concat</a> stage forwards the two received elements (<code>0</code> and <code>1</code>) to its downstream and registers the  completion of its first upstream, which will cause all still unfulfilled as well as future demand to go to its  second upstream (the <code>out</code> side of the <a href="../transformations/couplings.html">Coupling</a>).</p></li>
  <li>
  <p>The <a href="../transformations/reference/fanOutBroadcast.html">fanOutBroadcast</a> stage receives the two elements (<code>0</code> and <code>1</code>) and forwards them to both of its downstreams.</p></li>
  <li>
  <p>The <a href="../transformations/reference/take.html">take</a> stage forwards the elements to the main <a href="../drains.html">Drain</a> and registers that it has seen the first two of  the total 8 elements it is expecting.</p></li>
  <li>
  <p>The <a href="../transformations/reference/buffer.html">buffer</a> stage receives the two elements and immediately forwards them to the <a href="../transformations/reference/take.html">sliding</a> stage, which has  already demanded them at the very start of the stream. Then the <a href="../transformations/reference/buffer.html">buffer</a> stage immediately re-requests two more  elements from the <a href="../transformations/reference/fanOutBroadcast.html">fanOutBroadcast</a> stage.</p></li>
  <li>
  <p>The <a href="../transformations/reference/fanOutBroadcast.html">fanOutBroadcast</a> stage now has unfulfilled demand of 2 on its first sub and 6 on its seconds. It therefore  signals demand of 2 to the <a href="../transformations/reference/concat.html">concat</a> stage, which, via the <a href="../transformations/couplings.html">Coupling</a> and the <a href="../transformations/reference/take.html">map</a>, arrives at the  <a href="../transformations/reference/take.html">sliding</a> stage.</p></li>
  <li>
  <p>The <a href="../transformations/reference/take.html">sliding</a> stage produces its first window, a <code>Seq(0, 1)</code> to the <a href="../transformations/reference/take.html">map</a>, which in result produces a <code>1</code>  element to the <a href="../transformations/reference/concat.html">concat</a> stage (again, via the <a href="../transformations/couplings.html">Coupling</a>). Then it signals demand for the next element to  the <a href="../transformations/reference/buffer.html">buffer</a> stage.</p></li>
  <li>
  <p>The <a href="../transformations/reference/concat.html">concat</a>, which currently has unfulfilled demand of 2, receives the <code>1</code> element and produces it to the  <a href="../transformations/reference/fanOutBroadcast.html">fanOutBroadcast</a>, which pushes it to both of its sub streams, where it arrives at the main <a href="../drains.html">Drain</a> as well  as the <a href="../transformations/reference/buffer.html">buffer</a>.</p></li>
  <li>
  <p>As the <a href="../transformations/reference/buffer.html">buffer</a> has already seen demand of <code>1</code> from its downstream it immediately forwards this element to the  <a href="../transformations/reference/take.html">sliding</a> stage, which produces the next window, a <code>Seq(1, 1)</code> to the <a href="../transformations/reference/take.html">map</a>, which in result produces a <code>2</code>  to the <a href="../transformations/reference/concat.html">concat</a>, which forwards it to the <a href="../transformations/reference/fanOutBroadcast.html">fanOutBroadcast</a>, which produces it to both its downstreams.</p></li>
</ol>
<p>At this point a continuous cycle of demand and element production has been established and will run as long as nothing stops the process. In this case the process will be stopped by the <a href="../transformations/reference/take.html">take</a> stage. After it has received 8 elements it sends a <code>Cancel</code> signal to its upstream, the <a href="../transformations/reference/fanOutBroadcast.html">fanOutBroadcast</a>. Since that is configured with <code>eagerCancel = true</code> it will not continue to run &ldquo;on one leg&rdquo; (i.e. with only on sub stream left), but rather forward the <code>Cancel</code> signal to its own upstream, which causes all stages in the cycle to be stopped by the propagating cancellation.</p>
<h2><a href="#learnings" name="learnings" class="anchor"><span class="anchor-link"></span></a>Learnings</h2>
<p>When you play around with the code of this example you&rsquo;ll notice that things won&rsquo;t work when you remove the <a href="../transformations/reference/buffer.html">buffer</a> stage, reduce its size or change it&rsquo;s <code>RequestStrategy</code>. The reason is that a certain amount of demand is required <em>in the cycle</em> in order to kick things into motion and establish a perpetual flow of elements. When you follow the initial sequence of events closely, as outlined above, you&rsquo;ll see why this is the case.</p>
<p>The learning here is that, while cycles are a perfectly valid and useful streaming pattern, they can require additional <a href="../transformations/reference/buffer.html">buffer</a> stages to work correctly. Figuring out what exactly the minimum required buffer size is can be hard to figure out by simply looking at the stage setup. Starting out with a bigger buffer and reducing it until things break can be a good and pragmatic approach.</p>
<p>A second learning is that, if you have perpetual cycles, you need to think about a way to stop the stream if it&rsquo;s not supposed to run forever. A <a href="../transformations/reference/fanOutBroadcast.html">fanOutBroadcast</a> configured with <code>eagerCancel = true</code>, as shown in this example, is one possible way.</p>
                <div class="nav-next">
                    <p><strong>Next:</strong> <a href="../../usage/setup.html">Setup</a></p>
                </div>
                <!-- end: page -->
            </div>
        </section>
    </div>
</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="../../assets/vendor/jquery.browser.mobile/jquery.browser.mobile.js"></script>
<script src="../../assets/vendor/nanoscroller/nanoscroller.js"></script>
<script src="../../assets/vendor/highlight/highlight.js"></script>
<script src="../../assets/js/theme.js"></script>
<script src="../../assets/js/theme.init.js"></script>

</body>
</html>